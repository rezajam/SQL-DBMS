SELECT cus.name, xx.whenday AS DAY , xx.cost FROM yrb_customer cus, (SELECT xxx.cid, cast(xxx.when as date) AS whenday, xxx.cost FROM(SELECT AA.cid, AA.when, AA.qntyXprice + BB.cost as COST FROM(Select GG.cid , GG.when, SUM(GG.qnty*GG.weight) AS qntyXweight, SUM(GG.qnty*GG.price) AS qntyXprice FROM (select pur.cid, pur.title, pur.year, pur.when, pur.qnty, boo.weight, off.price from yrb_purchase pur, yrb_book boo, yrb_offer off WHERE boo.title = pur.title AND off.title = pur.title AND off.title = boo.title AND boo.year = pur.year AND off.year = pur.year AND off.year = boo.year AND pur.club = off.club ORDER BY pur.cid)GG GROUP BY GG.cid , GG.when) AA, (SELECT MM.cid, MM.when, MM.totalweight, MM.MINSHIPWEIGHT, ship.cost FROM yrb_shipping ship, (SELECT FF.cid, FF.when, FF.totalweight, MIN(shipweight)AS MINSHIPWEIGHT FROM(select HH.cid, HH.when, HH.weight AS totalweight, ship.weight AS shipweight, ship.cost from yrb_shipping ship, (SELECT KK.cid , KK.when, KK.weight FROM (Select GG.cid , GG.when, SUM(GG.qnty*GG.weight) AS weight FROM (select pur.cid, pur.title, pur.year, pur.when, pur.qnty, boo.weight, off.price from yrb_purchase pur, yrb_book boo, yrb_offer off WHERE boo.title = pur.title AND off.title = pur.title AND off.title = boo.title AND boo.year = pur.year AND off.year = pur.year AND off.year = boo.year AND pur.club = off.club ORDER BY pur.cid)GG GROUP BY GG.cid , GG.when)KK ) HH where ship.weight >= HH.weight) FF GROUP BY FF.cid, FF.when, FF.totalweight)MM WHERE MM.MINSHIPWEIGHT = ship.weight) BB WHERE AA.when = BB.when AND AA.cid = BB.cid AND AA.qntyXweight = BB.TOTALWEIGHT)xxx )xx WHERE xx.cid = cus.cid ; 
