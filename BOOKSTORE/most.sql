SELECT cus.name, XX.cat, XX.PRICEDD AS COST  FROM(SELECT HH.cid, DD.cat, DD.PRICEDD FROM ( SELECT MM.cid, MAX(MM.price) AS PRICEHH FROM (SELECT GG.cid, GG.cat, SUM(off.price) AS price FROM(select pur.cid, pur.club, pur.title, pur.year, boo.cat from yrb_purchase pur, yrb_book boo WHERE boo.title = pur.title AND boo.year = pur.year )GG, yrb_offer off WHERE GG.club = off.club AND GG.title = off.title AND GG.year = off.year GROUP BY GG.cid, GG.cat)MM GROUP BY MM.cid ) HH, (SELECT MM.cid, MM.cat, MAX(MM.price) AS PRICEDD FROM (SELECT GG.cid, GG.cat, SUM(off.price) AS price FROM(select pur.cid, pur.club, pur.title, pur.year, boo.cat from yrb_purchase pur, yrb_book boo WHERE boo.title = pur.title AND boo.year = pur.year )GG, yrb_offer off WHERE GG.club = off.club AND GG.title = off.title AND GG.year = off.year GROUP BY GG.cid, GG.cat)MM GROUP BY MM.cid, MM.cat) DD WHERE DD.cid = HH.cid AND DD.PRICEDD = HH.PRICEHH) XX, yrb_customer cus WHERE XX.cid = cus.cid;
